(function(self,$){let notes=[];function sendAjax(action,data={},callback){data.action=action;data.skin=dle_skin;ShowLoading();$.ajax({url:dle_root+'engine/mods/post_note/api.php',type:'POST',dataType:'json',data:data,}).done(function(d){callback&&callback(d);}).fail(function(e){DLEalert(e.responseText,dle_info);}).always(function(){HideLoading();});}
function deleteNote(news_id,callback){DLEconfirm('Delete a note?',dle_confirm,function(){sendAjax('deleteNote',{news_id:news_id,},d=>{callback&&callback()})})}
$(document).on('dblclick','.js-editNote',function(){let holder=$(this).parent('.note__holder');news_id=parseInt(holder.data('id'));if(!news_id)return;let comment=this;sendAjax('edit',{news_id:news_id,},d=>{$(comment).hide();let edit=$(d.html);edit.appendTo(holder);holder.find('.note__input').focus();holder.find('.note__save').on('click',function(){event.preventDefault();sendAjax('saveNote',{news_id:news_id,comment:$('.note__input').val(),public:$('.note__input-public').prop('checked')?1:0,},d=>{edit.remove();if(d.comment){$(comment).html(d.comment).removeClass('note--empty').show();if(d.public){$(comment).removeClass('note--private');}else{$(comment).addClass('note--private');}}else{$(comment).html(comment.dataset.placeholder).addClass('note--empty').removeClass('note--private').show();}});})
holder.find('.note__close').on('click',function(){event.preventDefault();edit.remove();$(comment).show();})
holder.find('.note__delete').on('click',function(){event.preventDefault();deleteNote(news_id,function(){edit.remove();$(comment).html(comment.dataset.placeholder).addClass('note--empty').removeClass('note--private').show();});})})}).on('click','.note__popup-trigger',function(){event.preventDefault();$('#note__popup').remove();let news_id=parseInt(this.dataset.id);$('body').append('<div id="note__popup"></div>');sendAjax('edit',{news_id:news_id,popup:true},d=>{let buttons={'Save':function(){sendAjax('saveNote',{news_id:news_id,comment:$('.note__input').val(),public:$('.note__input-public').prop('checked')?1:0,},d=>{DLEalert('Note saved successfully',dle_info);});},};$('#note__popup').html(d.html).dialog({title:'My note',width:600,buttons:buttons})})})
$(function(){$('.note--empty').each(function(){$(this).html(this.dataset.placeholder);})})})(window.post_note={},jQuery);